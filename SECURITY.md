# Security Architecture

## Overview

Autocode is a file-based workflow orchestrator plugin for OpenCode with minimal security surface. It operates entirely within the user's local project directory (`.autocode/`) and delegates all authentication and authorization to OpenCode's permission system. No network exposure, no credential handling, and no user authentication logic.

## Key Components

- [Permission Model](./src/agents/index.ts) - Agent-level tool access control via OpenCode's permission system
- [Input Sanitization](./src/tools/build.ts) - Plan name validation and filesystem path safety
- [File Operations](./src/tools/analyze.ts) - Scoped read/write within `.autocode/` directory
- [Configuration](./src/core/config.ts) - JSONC parsing with comment stripping

## Authentication

**Not applicable.** Autocode has no authentication logic. All user identity and session management is handled by OpenCode itself. The plugin receives an authenticated `client` instance from OpenCode's plugin context and uses it to create and manage sessions within OpenCode's infrastructure.

## Authorization

Autocode uses **OpenCode's permission system** to restrict agent access to specific tools. Each agent declares a `permission` object that controls which tools it can invoke.

### Permission Model

Permissions are defined per agent in [`src/agents/index.ts`](./src/agents/index.ts):

```typescript
permission: {
  "*": "deny",                    // Deny all by default
  "autocode_analyze*": "allow",   // Allow tools matching pattern
  "task": {
    "*": "allow",                 // Allow all task subagents
    "analyze": "deny",            // Except these specific ones
    "build": "deny"
  }
}
```

### Agents & Roles

- **plan**: Interactive planning agent
  - Allowed: `autocode_analyze*`, `grep`, `read`, `question`, `webfetch`, `task` (with restrictions)
  - Denied: `edit`, `bash`, `code`, `test`, `troubleshoot`
  - Purpose: Interview users, research problems, create plans (no code execution)

- **build**: Task generation agent
  - Allowed: `autocode_build*`, `question`, `skill` (plan-* only)
  - Denied: All other tools
  - Purpose: Convert approved plans into task directory structure (filesystem only)

## Security Features

- **Filesystem Scoping**: All file operations are scoped to `.autocode/` directory via `path.join()` with explicit directory names
- **Plan Name Sanitization**: Raw plan names are validated and sanitized before use in filesystem paths:
  - Lowercase conversion
  - Non-alphanumeric → underscore
  - Consecutive underscores collapsed
  - Leading/trailing underscores stripped
  - Word limit (7 words max, extras abbreviated)
  - Timestamp suffix added if directory exists (deduplication)
- **Permission-Based Tool Access**: Agents cannot invoke tools outside their declared permissions
- **No Credential Handling**: Plugin never stores, logs, or transmits secrets
- **No Network Exposure**: Plugin operates entirely within local filesystem and OpenCode's internal APIs
- **Configuration Validation**: JSONC parsing with comment stripping; missing config files fall back to safe defaults
- **Error Handling**: File operation errors are caught and reported without exposing system paths

## Non-Standard Practices

- **JSONC Comment Stripping**: Configuration loader uses regex-based comment removal instead of a dedicated JSONC parser. This is intentional for simplicity but may fail on edge cases (e.g., comments inside strings). Acceptable because config files are user-controlled and not untrusted input.

- **Path Traversal Prevention via Naming Convention**: Filesystem safety relies on sanitized plan names and explicit `path.join()` calls rather than canonicalization checks. This is safe because:
  - Plan names are generated/validated by the build agent (trusted)
  - Task names are provided by the build agent (trusted)
  - No user-supplied paths are used directly in filesystem operations
  - All paths are constructed relative to `.autocode/` directory

- **No Input Validation on Prompt Content**: Task prompts and review instructions are written as-is without sanitization. This is acceptable because:
  - Prompts are generated by the build agent (trusted)
  - They are read back by agents (not executed as code)
  - They are stored in markdown files (not interpreted)

## Threat Model

**Out of scope:**
- OpenCode authentication/authorization (delegated to OpenCode)
- Agent prompt injection (agents are trusted OpenCode components)
- Malicious user input (users control their own projects)
- Network attacks (no network exposure)
- Credential theft (no credentials stored)

**In scope:**
- Filesystem path traversal via plan/task names → **Mitigated by sanitization**
- Unintended file overwrites → **Mitigated by deduplication (timestamp suffix)**
- Accidental data loss → **Mitigated by `.archive/` directory for historical plans**
- Agent privilege escalation → **Mitigated by OpenCode's permission system**

## Configuration

Autocode reads optional configuration from `opencode.json` under the `autocode` section:

```jsonc
{
  "autocode": {
    "retry_count": 3,                      // Max retries before escalation
    "auto_install_dependencies": true,     // Auto-install on failure
    "parallel_sessions_limit": 4           // Max concurrent SDK sessions
  }
}
```

If `opencode.json` is missing or invalid, safe defaults are used. No secrets should be stored in this file.

## Dependency Security

- **zod**: Schema validation library (used for type definitions, not runtime validation)
- **gray-matter**: YAML/frontmatter parsing (used for plan metadata)
- **@opencode-ai/plugin**: OpenCode plugin SDK (trusted first-party)
- **@opencode-ai/sdk**: OpenCode SDK (trusted first-party)

No external authentication libraries, no credential storage, no network clients.
